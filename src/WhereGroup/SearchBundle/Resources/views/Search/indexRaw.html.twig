{% set conf = getParameter('metador') %}

{% if app.environment == 'dev' %}
    {% set BASEDIR = app.request.basepath ~ '/app_dev.php/' %}
{% else %}
    {% set BASEDIR = app.request.basepath ~ '/app.php/' %}
{% endif %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="{% block description %}{% endblock %}">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="{{ asset('bundles/wheregroupmetador/css/screen.css') }}">
        <link rel="stylesheet" href="{{ asset('bundles/wheregroupmetador/css/datepicker/zebra_datepicker_metallic.css') }}">
    </head>
    <body>
        <div class="metador-search" id="metador_search">
            {# HIDDEN SEARCH FIELDS #}
            <input type="hidden" name="page" id="search_page" value="1" />
            <input type="hidden" name="filter-dataset" id="filter-dataset" value="1" />
            <input type="hidden" name="filter-service" id="filter-service" value="1" />
            <input type="hidden" name="filter-series" id="filter-series" value="1" />

            <div class="search-extended">
                <input type="checkbox" name="filter-dataset" data-key="filter-dataset" class="search-filter-checkbox" checked="checked" /> Datensatz<br/>
                <input type="checkbox" name="filter-series" data-key="filter-series" class="search-filter-checkbox" checked="checked" /> Datensatzreihe<br/>
                <input type="checkbox" name="filter-service" data-key="filter-service" class="search-filter-checkbox" checked="checked" /> Dienst
                <div class="search-extended-close search_extended_toggle">
                    <div class="page-arrow"></div>
                </div>
            </div>
            <div class="search-content">
                <div class="search-prev disabled" id="search_prev" data-page="">
                    <div class="page-arrow"></div>
                </div>
                <div class="search-center">
                    <div class="search-center-form">
                        <div class="search-center-form-left" id="search_pageinfo">&nbsp;</div>
                        <div class="search-center-form-center">
                            <input type="text" id="search_find" class="search-input" name="find" value="" />
                        </div>
                        <div class="search-center-form-right">
                            <button id="search_find_submit" class="search-button">ok</button>
                            {#
                            <span class="search_extended_toggle">erweitert</span>
                            #}
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="search-center-content" id="search_content"></div>
                </div>
                <div class="search-next disabled" id="search_next" data-page="">
                    <div class="page-arrow"></div>
                </div>
            </div>
        </div>
            <script type="text/javascript">
                var BASEDIR = '{{ BASEDIR }}';
            </script>
            <script src="{{ asset('bundles/wheregroupmetador/js/jquery-1.8.3.min.js') }}"></script>
            <script type="text/javascript">
                $(document).ready(function() {

                    function search(firstPage) {
                        if (typeof firstPage !== 'undefined') {
                            $('#search_page').val(1);
                        };

                        $.ajax({
                            url: BASEDIR + "search/get",
                            data: {
                                'page': $('#search_page').val(),
                                'searchterm': $('#search_find').val(),
                                'filter-dataset' : $('#filter-dataset').val(),
                                'filter-service' : $('#filter-service').val(),
                                'filter-series'  : $('#filter-series').val()
                            },
                            type: "get",
                            dataType: "json",
                            success:  function(data) {

                                if (data.paging.count !== 0) {
                                    $('#search_pageinfo').html(
                                        data.paging.currentPage + ' / ' + data.paging.pages    
                                    );
                                } else {
                                    $('#search_pageinfo').html('');
                                };

                                if (typeof data.paging.prevPage !== 'undefined') {
                                    $('#search_prev').removeClass('disabled');
                                    $('#search_prev').attr('data-page', data.paging.prevPage);
                                } else {
                                    $('#search_prev').addClass('disabled');
                                    $('#search_prev').attr('data-page', 1);
                                };

                                if (typeof data.paging.nextPage !== 'undefined') {
                                    $('#search_next').removeClass('disabled');
                                    $('#search_next').attr('data-page', data.paging.nextPage);
                                } else {
                                    $('#search_next').addClass('disabled');
                                    $('#search_next').attr('data-page', '');
                                };

                                $('#search_content').html(data.html);
                            }
                        });   
                    }

                    $(document).on('click', '.search_extended_toggle', function() {
                        $('#metador_search').toggleClass('extended');
                    });

                    $(document).on('click', '#search_prev:not(.disabled)', function() {
                        $('#search_page').val($(this).attr('data-page'));
                        search();
                    });

                    $(document).on('click', '#search_next:not(.disabled)', function() {
                        $('#search_page').val($(this).attr('data-page')); 
                        search();
                    });

                    $(document).on('click', '#search_find_submit', function() {
                        $('#search_page').val(1); 
                        search();
                    });

                    $(document).on('click', '.metadata-extended-toggle', function() {
                        $(this).closest('.search-metadata').toggleClass('extended');
                    });

                    $(document).on('click', '.search-filter', function() {
                        $('#' + $(this).attr('data-key')).val($(this).val());
                        search(true);
                    });

                    $(document).on('click', '.search-filter-checkbox', function() {
                        var val = $(this).is(':checked') ? "1" : "0";

                        $('#' + $(this).attr('data-key')).val(val);
                        search(true);
                    });

                    $(document).on('click', '.metadata-extended-menu li', function() {
                        $(this).siblings().removeClass('act');
                        $(this).addClass('act');
                        $(this)
                            .closest('.metadata-extended')
                            .children('.metadata-extended-content')
                            .removeClass('act');

                        $("[data-id='" + $(this).attr('data-id') + "']", 
                            $(this).closest('.metadata-extended')
                        ).addClass('act');
                    });

                    search(true);
                });
            </script>
    </body>
</html>
